
<div class="container-fluid py-4">

    <!-- Tabs for small screens -->
  <ul class="nav nav-tabs d-lg-none mb-3" id="forumTabs" role="tablist" style="border-radius: 12px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
    <li class="nav-item" role="presentation">
      <a class="nav-link active" id="forum-rooms-tab" data-toggle="tab" href="#forum-rooms" role="tab" aria-controls="forum-rooms" aria-selected="true">Forum Rooms</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="recent-activities-tab" data-toggle="tab" href="#recent-activities" role="tab" aria-controls="recent-activities" aria-selected="false">Recent Activities</a>
    </li>
  </ul>


  <div class="row">
    <!-- Forum Room Section -->
    <div class="col-lg-8 mb-4 d-none d-lg-block">
      <div class="card forum-container shadow rounded-3 p-4">
        <div class="d-flex align-items-center mb-3">
            <h5 class="mb-0">General Forum</h5>

        
          <a href="{% url 'general-forum-form' %}" class="btn btn-sm create-room-btn ml-auto"><i class="fas fa-plus mr-2"></i> Create Room</a>
                        <a href="{% url 'user-forum-profile' request.user.id %}" class="btn btn-profile-nav btn-outline-none btn-sm d-flex align-items-center">
                          <i class="fas fa-user mr-2"></i> My Profile
                        </a>
        </div>

        <!-- Search Bar -->
        <div class="search-bar">
            <form method="get" action="" class="mb-3">
              <input type="text" name="q" class="form-control" placeholder="Search for rooms..." value="{{ request.GET.q }}">
            </form>
        </div>

        <!-- Room List -->
        <div class="forum-post">
          {% for room in rooms %}
         
            <div class="card room-card mb-3 forum-room-card">
              <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                   <a href="{% url 'user-forum-profile' room.host.id  %}">
                  <img src="{{ room.host.profile_picture.url }}" alt="avatar" class="rounded-circle me-2" width="42" height="42" style="object-fit: cover;">
                    <span class="ml-2 username">{{ room.host.username }}</span>
                    </a>
                  <small class=" ml-auto">{{ room.created|timesince }} ago</small>
                </div>
                 <a href="{% url 'room' room.id %}" class="text-decoration-none forum-room-link">
                <h6 class="card-title mb-1">{{ room.title }}</h6>
              
                <p class="mb-2">{{ room.content|truncatechars:300 }}</p>
                <div class="d-flex justify-content-between align-items-center mt-2">
        
                </div>
                  {% if room.image %}
                <img src="{{ room.image.url }}" alt="Room Image" width="100%" class="img-fluid rounded mb-2 forum-room-img">
                {% endif %}
                </a>
                <hr>
                  <span  class="float-right"><i class="fas fa-users"></i> {{ room.participants.count }} Joined</span>
                  
              </div>
            </div>
     
          {% empty %}
          <p class="text-light">No rooms found.</p>
          {% endfor %}
        </div>
      </div>
    </div>


    <!-- Recent Activities Section -->
    <div class="col-lg-4 d-none d-lg-block">
      <div class="recent-activity-fixed">
        <div class="card recent-act-card shadow rounded-3 p-4 h-100">
          <h5 class="mb-3">Recent Activities</h5>
          <div class="recent-activities">
            {% for message in room_comments %}
            
              <div class="card recent-act-inner-card mb-3">
                <div class="card-body">
                  <a href="{% url 'user-forum-profile' message.user.id %}">
                  <div class="d-flex align-items-center mb-2">
                    <img src="{{ message.user.profile_picture.url }}" alt="avatar" class="rounded-circle me-2" width="28" height="28" style="object-fit: cover;">
                    <span class="ml-2">{{ message.user.username }}</span>
                    </a>
                    <small class="ml-auto">{{ message.created|timesince }} ago</small>
                  </div>
                  
                  <a href="{% url 'room' message.room.id %}" class="text-decoration-none text-white">
                    <div>
                      <strong>replied to post “{{ message.room.title }}”</strong>
                      <div class="recent-act-comment p-2 mt-2 rounded">
                        {{ message }}
                      </div>
                    </div>
                  </a>
                </div>
              </div>
            
            {% empty %}
            <p class="text-light">No recent activity.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>





<!-- Tabs content for small/mobile screens -->
    <div class="col-12 d-lg-none p-0">
      <h6 class="mb-3">General Forum</h6>
      <div class="tab-content" id="forumTabsContent" style="min-height: 400px;">
        <div class="tab-pane fade show active" id="forum-rooms" role="tabpanel" aria-labelledby="forum-rooms-tab">
          
          <div class="card forum-container shadow rounded-3 p-lg-4 p-2">
                  <div class="d-flex justify-content-between align-items-center mb-3">
          <!-- <h5 class="mb-0">Forum Rooms</h5> -->
          <a href="{% url 'general-forum-form' %}" class="btn create-room-btn ml-auto"><i class="fas fa-plus mr-2"></i> Create Room</a>
                         <a href="{% url 'user-forum-profile' request.user.id %}" class="btn btn-profile-nav btn-outline-none btn-sm d-flex align-items-center">
  <i class="fas fa-user mr-2">  </i> My Profile
</a>
        </div>
        
             
        <form method="get" action="" class="mb-3">
          <input type="text" name="q" class="form-control" placeholder="Search for rooms..." value="{{ request.GET.q }}">

        </form>


  
             <div class="forum-post">
              {% for room in rooms %}
          <a href="{% url 'room' room.id %}" class="text-decoration-none text-white forum-room-link">
            <div class="card room-card mb-3 forum-room-card">
              <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                  <img src="{{ room.host.profile_picture.url }}" alt="avatar" class="rounded-circle me-2" width="32" height="32" style="object-fit: cover;">
                  <span>@{{ room.host.username }}</span>
                  <small class="ms-auto text-light">{{ room.created|timesince }} ago</small>
                </div>
                <h6 class="card-title mb-1">{{ room.title }}</h6>
                {% if room.image %}
                <img src="{{ room.image.url }}" alt="Room Image" class="img-fluid rounded mb-2 forum-room-img">
                {% endif %}
                <p class="mb-2">{{ room.content|truncatewords:30 }}</p>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <span><i class="fas fa-users"></i> {{ room.participants.count }} Joined</span>
                </div>
              </div>
            </div>
          </a>
          {% empty %}
          <p class="text-light">No rooms found.</p>
          {% endfor %}
            </div>
          </div>
          
        </div>

        
        <div class="tab-pane fade p-0" id="recent-activities" role="tabpanel" aria-labelledby="recent-activities-tab">
          <div class="card recent-act-card shadow rounded-3 p-lg-4 p-2">
            <!-- Recent Activities content (same as large screen) -->
             {% for message in room_comments %}
            <a href="{% url 'room' message.room.id %}" class="text-decoration-none text-white">
              <div class="card recent-act-inner-card mb-3">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <img src="{{ message.user.profile_picture.url }}" alt="avatar" class="rounded-circle me-2" width="28" height="28" style="object-fit: cover;">
                    <span>@{{ message.user.username }}</span>
                    <small class="ml-auto">{{ message.created|timesince }} ago</small>
                  </div>
                  <div>
                    <strong>replied to post “{{ message.room.title }}”</strong>
                    <div class="recent-act-comment p-2 mt-2 rounded">
                      {{ message }}
                    </div>
                  </div>
                </div>
              </div>
            </a>
            {% empty %}
            <p class="text-light">No recent activity.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>


<!-- Back to Top Button -->
<button id="backToTop" title="Go to top">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="white" class="bi bi-arrow-up" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M8 12a.5.5 0 0 0 .5-.5V4.707l3.147 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 4.707V11.5A.5.5 0 0 0 8 12z"/>
  </svg>
</button>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>


$(document).ready(function () {
  function loadGeneralRooms() {
  const query = $('input[name="q"]').val() || '';
    $.ajax({
      type: 'GET',
      url: "{% url 'get-rooms' %}",
       data: { q: query },  // <-- send query here
      success: function (response) {
        console.log("Fetched rooms:", response.rooms);
        const forumPost = $('.forum-post');
        forumPost.empty();

        if (response.rooms.length === 0) {
          forumPost.append('<p class="text-light">No rooms found.</p>');
        } else {
          response.rooms.forEach(function (item) {
            const roomHTML = `
             
                <div class="card room-card mb-3">
                  <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                      <a  href = "/core/user-forum-profile/${item.host.id}">
                      <img src="${item.host.profile_picture_url}" alt="avatar" class="rounded-circle me-2" width="42" height="42" style="object-fit: cover;">
                        <span class="ml-2">${item.host.username}</span>
                        </a>
                      <small class="ml-auto">${item.created_timesince}</small>
                    </div>
                    <a href="/core/room/${item.id}" class="text-decoration-none">
                    <h6 class="card-title mb-1">${item.title}</h6>
                  
                    <p class="mb-2">${item.content_truncated}</p>
                      ${item.image_url ? `<img src="${item.image_url}" alt="Room Image" class="img-fluid rounded mb-2" style="max-height:700px;  object-fit: cover; width: 100%;">` : ''}
                    <div class="d-flex justify-content-between align-items-center mt-2">
                      </a>
                      <hr>
                      <span class="float-right"><i class="fas fa-users"></i> ${item.participants_count} Joined</span>
                       
                    </div>
                  </div>
                </div>
             `;
            forumPost.append(roomHTML);
          });
        }
      },
      error: function (xhr, status, error) {
        console.error("Error fetching rooms:", error);
        $('#forum-post').html('<p class="text-danger">Failed to load rooms.</p>');
      }
    });
  }

  // Initial load
  loadGeneralRooms();

  // Repeat every 5 seconds (not best, but simple for now)
  setInterval(loadGeneralRooms, 5000);



  $('form').on('submit', function(e) {
  e.preventDefault();
  loadGeneralRooms();
});
});





// back top
  const backToTopBtn = document.getElementById("backToTop");

  window.addEventListener("scroll", function () {
    if (window.scrollY > 200) {
      backToTopBtn.classList.add("show");
    } else {
      backToTopBtn.classList.remove("show");
    }
  });

  backToTopBtn.addEventListener("click", function () {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });





</script>
